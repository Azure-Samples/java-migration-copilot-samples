# Azure Deployment Plan for assets-manager Project

## **Goal**
Deploy the Java Spring Boot assets-manager multi-module application to Azure Kubernetes Service (AKS) using Azure CLI, with full provisioning of required Azure infrastructure.

## **Project Information**
**Assets Manager**  
- **Stack**: Java 21, Spring Boot 3.4.3, Maven multi-module project  
- **Type**: Asset management system with web frontend and background worker for image processing  
- **Containerization**: Dockerfiles present for both web and worker modules  
- **Dependencies**: Azure Storage (Blob), Azure Service Bus, Azure Database for PostgreSQL  
- **Hosting**: Azure Kubernetes Service (AKS)

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurekubernetesservice_assetsmanagerweb["`Name: assets-manager-web
Path: web
Language: java
Port: 8080`"]
svcazurekubernetesservice_assetsmanagerworker["`Name: assets-manager-worker
Path: worker
Language: java
Port: 8080`"]
subgraph "Compute Resources"
%% Resources
subgraph akscluster["Azure Kubernetes Service (AKS) Cluster"]
azurekubernetesservice_assetsmanagerweb("`assets-manager-web (Containerized Service)`")
azurekubernetesservice_assetsmanagerworker("`assets-manager-worker (Containerized Service)`")
end
akscluster:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azurestorageaccount_azurestorage["`azure-storage (Azure Storage Account)`"]
azuredatabaseforpostgresql_postgresqldb["`postgresql-db (Azure Database for PostgreSQL)`"]
azureservicebus_servicebusqueue["`servicebus-queue (Azure Service Bus)`"]
end
%% Relationships
svcazurekubernetesservice_assetsmanagerweb --> |"hosted on"| azurekubernetesservice_assetsmanagerweb
azurekubernetesservice_assetsmanagerweb -.-> |"system-identity"| azurestorageaccount_azurestorage
azurekubernetesservice_assetsmanagerweb -.-> |"system-identity"| azuredatabaseforpostgresql_postgresqldb
azurekubernetesservice_assetsmanagerweb -.-> |"system-identity"| azureservicebus_servicebusqueue
svcazurekubernetesservice_assetsmanagerworker --> |"hosted on"| azurekubernetesservice_assetsmanagerworker
azurekubernetesservice_assetsmanagerworker -.-> |"system-identity"| azurestorageaccount_azurestorage
azurekubernetesservice_assetsmanagerworker -.-> |"system-identity"| azuredatabaseforpostgresql_postgresqldb
azurekubernetesservice_assetsmanagerworker -.-> |"system-identity"| azureservicebus_servicebusqueue
```

- The AKS cluster hosts both containerized services (web and worker)
- Both services connect to the same Azure Storage Account for blob storage operations
- PostgreSQL database stores image metadata and application data
- Service Bus facilitates asynchronous communication between web and worker services
- All connections use Managed Identity for secure authentication

## **Recommended Azure Resources**

### Application assets-manager-web:
- **Hosting Service Type**: Azure Kubernetes Service
- **SKU**: Standard_D2s_v3 (2 vCPUs, 8 GB RAM) - Good balance for web applications
- **Configuration**:
    - Language: java  
    - Environment Variables: 
      - AZURE_STORAGE_ACCOUNT_NAME
      - AZURE_STORAGE_BLOB_CONTAINER_NAME
      - AZURE_CLIENT_ID
      - AZURE_SERVICEBUS_NAMESPACE
    - dockerFilePath: web/Dockerfile
    - dockerContext: .
- **Dependencies Resource**:
    - **Azure Storage Account**
      - SKU: Standard_LRS - Cost-effective for general-purpose storage
      - Service Type: Azure Storage Account (Blob Storage)
      - Connection Type: Managed Identity
      - Environment Variables: [AZURE_STORAGE_ACCOUNT_NAME, AZURE_STORAGE_BLOB_CONTAINER_NAME]
    - **PostgreSQL Database**
      - SKU: Burstable_B1ms (1 vCore, 2 GB RAM) - Suitable for development/small production
      - Service Type: Azure Database for PostgreSQL
      - Connection Type: Managed Identity
      - Environment Variables: [Database connection configured in Spring datasource]
    - **Service Bus**
      - SKU: Standard - Supports queues and topics
      - Service Type: Azure Service Bus
      - Connection Type: Managed Identity
      - Environment Variables: [AZURE_SERVICEBUS_NAMESPACE]

### Application assets-manager-worker:
- **Hosting Service Type**: Azure Kubernetes Service
- **SKU**: Standard_D2s_v3 (2 vCPUs, 8 GB RAM) - Good for background processing
- **Configuration**:
    - Language: java  
    - Environment Variables: 
      - AZURE_STORAGE_ACCOUNT_NAME
      - AZURE_STORAGE_BLOB_CONTAINER_NAME
      - AZURE_CLIENT_ID
      - AZURE_SERVICEBUS_NAMESPACE
    - dockerFilePath: worker/Dockerfile
    - dockerContext: .
- **Dependencies Resource**: Same as web service (shared resources)

## **Recommended Supporting Services**:
- **Application Insights**: For monitoring and telemetry
- **User-Assigned Managed Identity**: For secure access to Azure resources
- **Log Analytics Workspace**: Centralized logging for AKS cluster and applications
- **Key Vault**: Store sensitive configuration and connection strings
- **Container Registry**: Store and manage Docker images

## **Recommended Security Configurations**:
- User-Assigned Managed Identity must have permissions to access Key Vault
- User-Assigned Managed Identity must be assigned to AKS cluster
- **AcrPull role assignment**: User managed identity must have **AcrPull** role ("7f951dda-4ed3-4680-a7ca-43fe172d538d") assigned to the container registry
- Storage Blob Data Contributor role for accessing blob storage
- Service Bus Data Owner role for message processing
- PostgreSQL database configured for Azure AD authentication

## **Execution Steps**
> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**

### Execution Steps:
1. **Env setup for AzCLI**:
    - [ ] Install AZ CLI if not installed
    - [ ] Ensure there is a default subscription set
    - [ ] Subscription ID: Use default subscription

2. **Provision Azure Infrastructure with azcli**:
    - [ ] Provisioning tool: azcli. Expected files: Azure CLI scripts for provisioning
    - [ ] Check quota availability for required Azure resource types (including Microsoft.Compute/virtualMachines for AKS nodes)
    - [ ] Generate Azure CLI scripts for provisioning if they don't exist
    - [ ] Run Azure CLI scripts to provision the resources and confirm the result
    - [ ] Fix Azure CLI scripts and retry if there's any error in the provisioning files

3. **Containerization**:
    - [ ] Verify existing Dockerfiles (web/Dockerfile, worker/Dockerfile)
    - [ ] Test Docker builds for both services
    - [ ] Output: Docker artifacts ready for deployment

4. **Deployment**:
    - [ ] **Azure Kubernetes Service Deployment**:
        - [ ] Create Kubernetes Manifests (deployments, services, ingress)
        - [ ] Prepare the deployment script (build + push images to ACR, deploy to AKS with kubectl)
        - [ ] Deploy with the files and verify the output
        - [ ] Output: Kubernetes YAML files, deployment script
    - [ ] **Deployment Validation**:
        - [ ] Check the deployed applications are running
        - [ ] Verify service connectivity and health endpoints

5. **Summarize Deployment Result**:
    - [ ] Use `appmod-summarize-result` tool to summarize the deployment result
    - [ ] Generating files: .azure/summary.copilotmd

## **Progress Tracking**
- Copilot must create and update `.azure/progress.copilotmd` after each step
- Progress should include:  
  - ‚úÖ Completed tasks  
  - üî≤ Pending tasks  
  - ‚ùå Failed tasks with error notes
- If a script fails, log the error, regenerate/fix the script, and retry until the step completes